<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avalia√ß√£o N√≠vel de Autoestima ‚Äî Instituto Impulso</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

  <style>
    body{
      background: linear-gradient(135deg, #f6fdf8, #e9fbf0);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .card-soft{
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(16,185,129,.14);
      box-shadow: 0 18px 50px rgba(2,6,23,.07);
      backdrop-filter: blur(10px);
    }
    .scale-option{
      transition: all .14s ease;
      border: 2px solid #d1d5db;
      border-radius: 12px;
      padding: 10px 8px;
      text-align: center;
      cursor: pointer;
      background: linear-gradient(135deg,#ffffff,#f7fee7);
      font-weight: 700;
      user-select:none;
    }
    .scale-option:hover{ background:#f0fdf4; border-color:#34d399; }
    .scale-option:active{ transform: scale(1.04); }
    .scale-option.selected{
      background: linear-gradient(135deg,#34d399,#10b981);
      color:#064e3b;
      border-color:#10b981;
    }
    .btn-primary{ background: linear-gradient(135deg,#34d399,#10b981); transition: transform .1s ease; }
    .btn-primary:active{ transform: scale(1.02); }
    .btn-secondary{ background: linear-gradient(135deg,#6b7280,#4b5563); }
    .progress-rail{ height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .progress-fill{ height:100%; background: linear-gradient(90deg,#34d399,#10b981); transition: width .25s ease; }

    #themesChart{ max-width: 920px !important; height: 360px !important; margin: 0 auto; }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">
  <div class="max-w-3xl w-full card-soft rounded-2xl p-6 md:p-8">

    <div class="text-center">
      <div class="text-2xl md:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-emerald-700 to-green-600">
        Instituto Impulso Coaching de Lideran√ßa
      </div>
      <div class="mt-1 text-sm md:text-base text-emerald-900/70 font-semibold">
        A mudan√ßa pode acontecer em um instante.
      </div>

      <h1 class="mt-4 text-3xl md:text-4xl font-extrabold text-gray-900">
        Avalia√ß√£o N√≠vel de Autoestima
      </h1>
      <p class="mt-2 text-gray-600 text-sm md:text-base">
        40 afirma√ß√µes ‚Ä¢ escala 1‚Äì5 ‚Ä¢ resultado imediato
      </p>
    </div>

    <!-- INTRO SIMPLES -->
    <div id="intro" class="mt-6">
      <div class="bg-white/70 border border-emerald-100 rounded-xl p-4">
        <p class="text-sm font-extrabold text-gray-800 mb-3">Dados do participante</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="name" type="text" placeholder="Nome *"
            class="border border-emerald-200 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-emerald-300 bg-white" />
          <input id="email" type="email" placeholder="Email *"
            class="border border-emerald-200 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-emerald-300 bg-white" />
        </div>

        <div class="flex justify-end mt-4">
          <button onclick="startTest()" class="btn-primary text-emerald-950 px-5 py-2.5 rounded-xl shadow-sm font-extrabold">
            Iniciar
          </button>
        </div>

        <p class="mt-3 text-xs text-gray-500">
          Observa√ß√£o: ferramenta educativa de desenvolvimento pessoal. Se houver sofrimento emocional intenso, considere apoio profissional qualificado.
        </p>
      </div>
    </div>

    <!-- QUEST√ïES (1 por tela) -->
    <div id="test" class="hidden mt-6">
      <div id="questionHost"></div>
    </div>

    <!-- RESULTADO -->
    <div id="result" class="hidden mt-6">
      <div class="bg-white/70 border border-emerald-100 rounded-xl p-4">
        <p class="text-sm font-extrabold text-gray-800">Resultado</p>
        <p id="personalData" class="text-xs text-gray-600 mt-1"></p>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="bg-white rounded-xl border border-gray-100 p-4">
            <p class="text-xs font-extrabold text-gray-500">IGA</p>
            <p id="igaPct" class="text-4xl font-extrabold text-emerald-700">‚Äî%</p>
            <p id="igaLevel" class="text-xs text-gray-600 mt-1">‚Äî</p>
          </div>
          <div class="bg-white rounded-xl border border-gray-100 p-4 md:col-span-2">
            <p class="text-xs font-extrabold text-gray-500">Perfil</p>
            <p id="profileTitle" class="text-lg font-extrabold text-gray-900">‚Äî</p>
            <p id="profileText" class="text-xs text-gray-700 mt-1">‚Äî</p>
          </div>
        </div>

        <!-- ALERTAS -->
        <div id="alerts" class="mt-4 hidden"></div>

        <!-- GR√ÅFICO POR TEMAS -->
        <div class="mt-4 bg-white rounded-xl border border-gray-100 p-4">
          <p class="text-xs font-extrabold text-gray-500 mb-2">Gr√°fico por temas (m√≥dulos)</p>
          <canvas id="themesChart"></canvas>
          <p class="text-[11px] text-gray-500 mt-2">
            Refer√™ncia: m√≠nimo saud√°vel = <span class="font-bold" id="minHealthyLabel">‚Äî</span>.
          </p>
        </div>

        <!-- EXPLICA√á√ÉO DETALHADA -->
        <div class="mt-4 bg-white rounded-xl border border-gray-100 p-4">
          <p class="text-xs font-extrabold text-gray-500 mb-2">Explica√ß√£o detalhada por m√≥dulo</p>
          <div id="moduleExplain" class="space-y-3"></div>
        </div>

        <div class="mt-4 flex flex-col md:flex-row gap-2 justify-end">
          <button onclick="generatePDF()" class="btn-primary text-emerald-950 px-5 py-2.5 rounded-xl shadow-sm font-extrabold">Salvar PDF</button>
          <button onclick="saveOfflineHTML()" class="bg-white border border-emerald-200 text-emerald-900 px-5 py-2.5 rounded-xl shadow-sm font-extrabold">Salvar HTML</button>
          <button onclick="restart()" class="btn-secondary text-white px-5 py-2.5 rounded-xl shadow-sm font-extrabold">Nova</button>
        </div>

        <p class="mt-3 text-[11px] text-gray-500" id="autoActionsHint"></p>
      </div>
    </div>

  </div>

<script>
"use strict";

/* =========================
   CONFIG
   ========================= */
const MIN_HEALTHY_PCT = 70; // m√≠nimo saud√°vel por tema/m√≥dulo (ajuste aqui)
const MAILTO_TO = "impulsoflow@gmail.com";

/* =========================
   DIMENS√ïES / M√ìDULOS
   ========================= */
const DIMENSIONS = [
  { key:"d1", name:"Autovaloriza√ß√£o e Autoaceita√ß√£o", items:[
    "Sinto que sou uma pessoa de valor, pelo menos tanto quanto outras pessoas.",
    "Consigo reconhecer qualidades em mim, mesmo quando erro.",
    "Aceito que tenho limita√ß√µes sem me diminuir por isso.",
    "Consigo me tratar com respeito, mesmo em dias dif√≠ceis.",
    "Eu me sinto digno(a) de amor e considera√ß√£o.",
    "Eu me reconhe√ßo como algu√©m importante para mim mesmo(a).",
    "Eu me permito ser humano(a), sem me exigir perfei√ß√£o.",
    "Eu consigo separar meu valor pessoal dos meus resultados."
  ]},
  { key:"d2", name:"Autoconfian√ßa e Compet√™ncia Percebida", items:[
    "Eu confio que consigo aprender coisas novas quando necess√°rio.",
    "Eu me considero capaz de lidar com problemas do dia a dia.",
    "Quando falho, consigo tentar de novo sem desistir de mim.",
    "Eu me sinto competente naquilo que fa√ßo na maior parte do tempo.",
    "Eu tomo decis√µes com razo√°vel seguran√ßa.",
    "Eu reconhe√ßo minhas conquistas sem minimiz√°-las.",
    "Eu consigo me posicionar quando preciso.",
    "Eu sinto que tenho recursos internos para enfrentar desafios."
  ]},
  { key:"d3", name:"Autoimagem e Aceita√ß√£o Social", items:[
    "Eu me sinto confort√°vel em ser quem eu sou perto de outras pessoas.",
    "Eu n√£o me comparo o tempo todo de forma que me fa√ßa mal.",
    "Eu consigo receber elogios sem desconfiar ou rejeitar.",
    "Eu me sinto pertencente em ambientes sociais importantes para mim.",
    "Eu consigo dizer ‚Äún√£o‚Äù sem medo excessivo de rejei√ß√£o.",
    "Eu n√£o baseio meu valor apenas na opini√£o dos outros.",
    "Eu me sinto relativamente seguro(a) com minha imagem.",
    "Eu consigo estar em grupo sem me sentir inferior."
  ]},
  { key:"d4", name:"Autocompaix√£o e Di√°logo Interno", items:[
    "Quando erro, eu evito me chamar de nomes ou me humilhar.",
    "Eu consigo me acolher quando estou triste ou frustrado(a).",
    "Eu falo comigo mesmo(a) como falaria com algu√©m que amo.",
    "Eu consigo reconhecer que sofrer faz parte de ser humano.",
    "Eu me permito descansar sem culpa excessiva.",
    "Eu consigo ser firme comigo sem ser cruel.",
    "Eu noto quando meu cr√≠tico interno aparece e consigo ajustar o tom.",
    "Eu consigo me perdoar por escolhas do passado."
  ]},
  { key:"d5", name:"Estabilidade Emocional e Resili√™ncia", items:[
    "Eu consigo me acalmar depois de situa√ß√µes estressantes.",
    "Eu n√£o fico preso(a) por muito tempo em pensamentos autodepreciativos.",
    "Eu consigo pedir ajuda quando preciso.",
    "Eu me recupero relativamente bem ap√≥s cr√≠ticas ou conflitos.",
    "Eu consigo tolerar frustra√ß√£o sem me desorganizar totalmente.",
    "Eu consigo manter esperan√ßa mesmo em fases dif√≠ceis.",
    "Eu reconhe√ßo minhas emo√ß√µes sem ser dominado(a) por elas.",
    "Eu aprendo com dificuldades ao inv√©s de me definir por elas."
  ]}
];

const LIKERT = [
  {v:1, label:"Discordo totalmente"},
  {v:2, label:"Discordo"},
  {v:3, label:"Neutro"},
  {v:4, label:"Concordo"},
  {v:5, label:"Concordo totalmente"}
];

/* =========================
   QUESTION√ÅRIO (embaralhado)
   ========================= */
function buildQuestionsShuffled(){
  const arr = [];
  DIMENSIONS.forEach((d, di) => d.items.forEach((text, qi) => arr.push({ di, qi, text })));
  for (let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/* =========================
   ESTADO
   ========================= */
let user = { name:"", email:"" };
let questions = [];
let current = 0;
let responses = []; // 40 respostas, ordem embaralhada
let chartInstance = null;

/* =========================
   UTIL
   ========================= */
function sanitize(s){ return DOMPurify.sanitize(String(s || "")); }
function validateEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
function pct(n){ return Math.max(0, Math.min(100, Math.round(n))); }
function todayBR(){ return new Date().toLocaleDateString("pt-BR",{year:"numeric",month:"2-digit",day:"2-digit"}); }

function score(){
  const sums = DIMENSIONS.map(()=>0);
  const maxPerDim = 8 * 5;

  for(let i=0;i<questions.length;i++){
    sums[questions[i].di] += responses[i];
  }

  const pctByDim = sums.map(s => (s / maxPerDim) * 100);
  const iga = pctByDim.reduce((a,b)=>a+b,0) / pctByDim.length;
  return { sums, pctByDim, iga };
}

function igaLevel(igaPct){
  if(igaPct < 35) return "Muito baixo";
  if(igaPct < 55) return "Baixo";
  if(igaPct < 70) return "Moderado";
  if(igaPct < 85) return "Bom";
  return "Excelente";
}

function igaProfile(igaPct){
  if(igaPct < 35) return { title:"üî¥ O Cr√≠tico Interno", text:"Indicador de autocr√≠tica alta e base interna fragilizada. Priorize autocompaix√£o, apoio e reconstru√ß√£o de valor pessoal." };
  if(igaPct < 55) return { title:"üü† O Comparador Inseguro", text:"Oscila√ß√µes e sensibilidade √† valida√ß√£o externa. O foco √© construir consist√™ncia e autonomia emocional." };
  if(igaPct < 70) return { title:"üü° O Realista em Constru√ß√£o", text:"H√° recursos internos, mas eles ficam inst√°veis sob press√£o. Ajustes em h√°bitos e di√°logo interno geram alta evolu√ß√£o." };
  if(igaPct < 85) return { title:"üü¢ O Confiante Equilibrado", text:"Boa base interna e recupera√ß√£o emocional. Reforce rotina e limites para manter estabilidade em fases dif√≠ceis." };
  return { title:"üü£ O Autol√≠der", text:"Autoestima est√°vel, autorregula√ß√£o e clareza de valor. O pr√≥ximo n√≠vel √© consist√™ncia e influ√™ncia positiva em rela√ß√µes/lideran√ßa." };
}

function bandExplain(p){
  if(p < 35) return "Faixa cr√≠tica: tend√™ncia a autodeprecia√ß√£o, vergonha e evita√ß√£o. Pode exigir apoio estruturado.";
  if(p < 55) return "Faixa de risco: autoestima inst√°vel, vulner√°vel a cr√≠ticas/compara√ß√£o. O objetivo √© estabilizar base interna.";
  if(p < 70) return "Faixa intermedi√°ria: voc√™ tem ferramentas, mas n√£o est√£o consistentes. Trabalhar h√°bitos e cren√ßas-chave melhora r√°pido.";
  if(p < 85) return "Faixa saud√°vel: bons recursos e estabilidade. O foco √© refinar e manter o padr√£o sob estresse.";
  return "Faixa √≥tima: padr√£o interno s√≥lido, boa autogest√£o e autorrespeito consistente.";
}

/* =========================
   UI: in√≠cio / quest√µes
   ========================= */
function startTest(){
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();

  if(!name || !email || !validateEmail(email)){
    alert("Preencha Nome e Email corretamente.");
    return;
  }

  user = { name, email };
  questions = buildQuestionsShuffled();
  responses = new Array(questions.length).fill(null);
  current = 0;

  document.getElementById("intro").classList.add("hidden");
  document.getElementById("test").classList.remove("hidden");
  renderQuestion();
}

function renderQuestion(){
  const total = questions.length;
  const qNum = current + 1;
  const progress = Math.round(((qNum - 1) / total) * 100);
  const q = questions[current];

  const html = `
    <div class="bg-white/70 border border-emerald-100 rounded-xl p-4">
      <div class="mb-3">
        <div class="flex items-center justify-between gap-2">
          <p class="text-xs font-extrabold text-gray-600">Progresso</p>
          <p class="text-xs font-extrabold text-gray-600">${qNum}/${total}</p>
        </div>
        <div class="progress-rail mt-2">
          <div class="progress-fill" style="width:${progress}%"></div>
        </div>
      </div>

      <p class="text-xl md:text-2xl font-normal text-center text-gray-900 leading-snug">
        "${sanitize(q.text)}"
      </p>

      <div class="grid grid-cols-5 gap-2 mt-5">
        ${LIKERT.map(opt => `
          <div class="scale-option ${responses[current]===opt.v?'selected':''}" onclick="selectAnswer(${opt.v})">
            ${opt.v}<br><small class="text-[10px] font-semibold">${sanitize(opt.label)}</small>
          </div>
        `).join("")}
      </div>

      <div class="flex flex-col md:flex-row items-center justify-center gap-2 mt-5">
        <button onclick="prev()" class="px-5 py-2.5 rounded-xl font-extrabold border border-gray-200 bg-white text-gray-700 ${current===0?'opacity-40 cursor-not-allowed':''}" ${current===0?'disabled':''}>
          Anterior
        </button>

        ${current < total-1
          ? `<button onclick="next()" class="btn-primary text-emerald-950 px-6 py-2.5 rounded-xl shadow-sm font-extrabold ${responses[current]===null?'opacity-50 cursor-not-allowed':''}">
              Pr√≥xima
            </button>`
          : `<button onclick="finish()" class="btn-primary text-emerald-950 px-6 py-2.5 rounded-xl shadow-sm font-extrabold ${responses[current]===null?'opacity-50 cursor-not-allowed':''}">
              Ver resultado
            </button>`
        }
      </div>
    </div>
  `;
  document.getElementById("questionHost").innerHTML = html;
}

function selectAnswer(v){ responses[current] = v; renderQuestion(); }

function next(){
  if(responses[current] === null){ alert("Selecione uma op√ß√£o antes de continuar."); return; }
  current++; renderQuestion();
}

function prev(){ if(current===0) return; current--; renderQuestion(); }

/* =========================
   RESULTADO + GR√ÅFICOS + ALERTAS
   ========================= */
function renderAlerts(pctByDim){
  const low = pctByDim
    .map((v,i)=>({v:Math.round(v), i}))
    .filter(x=>x.v < MIN_HEALTHY_PCT);

  const wrap = document.getElementById("alerts");
  if(low.length === 0){
    wrap.classList.add("hidden");
    wrap.innerHTML = "";
    return;
  }

  wrap.classList.remove("hidden");
  wrap.className = "mt-4 space-y-2";

  wrap.innerHTML = low.map(x => `
    <div class="bg-amber-50 border border-amber-200 rounded-xl p-3">
      <p class="text-sm font-extrabold text-amber-900">Alerta: abaixo do m√≠nimo saud√°vel</p>
      <p class="text-xs text-amber-900 mt-1">
        <span class="font-bold">${sanitize(DIMENSIONS[x.i].name)}</span> ‚Äî ${x.v}% (m√≠nimo saud√°vel: ${MIN_HEALTHY_PCT}%).
      </p>
      <p class="text-xs text-amber-800 mt-1">
        Interpreta√ß√£o: ${sanitize(bandExplain(x.v))}
      </p>
    </div>
  `).join("");
}

function renderThemesChart(pctByDim){
  document.getElementById("minHealthyLabel").textContent = `${MIN_HEALTHY_PCT}%`;

  const labels = DIMENSIONS.map(d=>d.name);
  const data = pctByDim.map(v=>Math.round(v));

  const ctx = document.getElementById("themesChart").getContext("2d");
  Chart.register(ChartDataLabels);

  if(chartInstance){ chartInstance.destroy(); chartInstance = null; }

  chartInstance = new Chart(ctx, {
    type:"bar",
    data:{
      labels,
      datasets:[
        {
          label:"% por m√≥dulo",
          data,
          backgroundColor: data.map(v => v < MIN_HEALTHY_PCT ? "rgba(245,158,11,0.55)" : "rgba(16,185,129,0.55)"),
          borderColor: data.map(v => v < MIN_HEALTHY_PCT ? "rgba(217,119,6,1)" : "rgba(5,150,105,1)"),
          borderWidth: 1,
          borderRadius: 10,
          borderSkipped: false
        }
      ]
    },
    options:{
      indexAxis:"y",
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{
          beginAtZero:true,
          max:100,
          ticks:{ stepSize:10, color:"#374151", font:{ size:11 } },
          grid:{ color:"rgba(0,0,0,0.06)" }
        },
        y:{
          ticks:{ color:"#111827", font:{ size:12, weight:"bold" } },
          grid:{ display:false }
        }
      },
      plugins:{
        legend:{ display:false },
        datalabels:{
          anchor:"end",
          align:"right",
          formatter:(v)=> `${v}%`,
          color:"#065f46",
          font:{ weight:"bold", size:13 },
          offset: 8
        }
      }
    },
    plugins: [{
      id: "minHealthyLine",
      afterDraw(chart){
        const {ctx, chartArea, scales} = chart;
        const x = scales.x.getPixelForValue(MIN_HEALTHY_PCT);
        ctx.save();
        ctx.strokeStyle = "rgba(245,158,11,0.95)";
        ctx.lineWidth = 2;
        ctx.setLineDash([6,6]);
        ctx.beginPath();
        ctx.moveTo(x, chartArea.top);
        ctx.lineTo(x, chartArea.bottom);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = "rgba(180,83,9,1)";
        ctx.font = "bold 11px Inter, Arial";
        ctx.fillText(`m√≠n. saud√°vel ${MIN_HEALTHY_PCT}%`, x + 6, chartArea.top + 14);
        ctx.restore();
      }
    }]
  });
}

function moduleDetailHTML(pctByDim){
  return pctByDim.map((p, i) => {
    const v = Math.round(p);
    const status = v < MIN_HEALTHY_PCT ? "Aten√ß√£o" : "OK";
    const badgeClass = v < MIN_HEALTHY_PCT ? "bg-amber-100 text-amber-900 border-amber-200" : "bg-emerald-100 text-emerald-900 border-emerald-200";
    return `
      <div class="border border-gray-100 rounded-xl p-3 bg-gray-50">
        <div class="flex items-start justify-between gap-2">
          <div>
            <p class="text-sm font-extrabold text-gray-900">${sanitize(DIMENSIONS[i].name)}</p>
            <p class="text-xs text-gray-700 mt-1">${sanitize(bandExplain(v))}</p>
          </div>
          <div class="shrink-0">
            <span class="text-xs font-extrabold px-2 py-1 rounded-full border ${badgeClass}">${status} ‚Ä¢ ${v}%</span>
          </div>
        </div>
        <div class="mt-2 text-xs text-gray-700">
          <p class="font-bold">Leitura pr√°tica:</p>
          <ul class="list-disc list-inside mt-1 space-y-1">
            <li>${sanitize(practicalLine(i, v, 1))}</li>
            <li>${sanitize(practicalLine(i, v, 2))}</li>
            <li>${sanitize(practicalLine(i, v, 3))}</li>
          </ul>
        </div>
      </div>
    `;
  }).join("");
}

function practicalLine(dimIndex, v, n){
  const name = DIMENSIONS[dimIndex].name;
  const low = v < MIN_HEALTHY_PCT;
  const mid = v >= MIN_HEALTHY_PCT && v < 85;
  if(low){
    const tips = [
      `Priorize 1 h√°bito simples por dia para ${name.toLowerCase()} (consist√™ncia antes de intensidade).`,
      `Reduza gatilhos de autocr√≠tica e adicione um ‚Äúritual de reparo‚Äù ap√≥s erro (ex.: pausa, respira√ß√£o, reframe).`,
      `Busque apoio: conversa orientada + plano semanal de a√ß√µes pequenas (5‚Äì15 min).`
    ];
    return tips[n-1];
  }
  if(mid){
    const tips = [
      `Voc√™ j√° tem base; seu ganho est√° em consist√™ncia sob press√£o.`,
      `Escolha 1 situa√ß√£o recorrente e treine uma resposta nova (script de di√°logo interno/limites/posicionamento).`,
      `Me√ßa evolu√ß√£o: 1 nota semanal (0‚Äì10) para perceber tend√™ncia e n√£o s√≥ ‚Äúo dia‚Äù.`
    ];
    return tips[n-1];
  }
  const tips = [
    `Este √© um ponto forte. Proteja sua rotina e seus limites para manter estabilidade.`,
    `Use esse m√≥dulo como ‚Äú√¢ncora‚Äù para elevar os demais (o que funciona aqui pode ser replicado).`,
    `Ensinar/compartilhar o que voc√™ faz bem consolida o padr√£o interno.`
  ];
  return tips[n-1];
}

/* =========================
   A√á√ïES AUTOM√ÅTICAS: PDF + HTML + MAILTO
   ========================= */
function buildMailtoBody(data){
  const lines = [];
  lines.push("Resultado ‚Äî Avalia√ß√£o N√≠vel de Autoestima");
  lines.push(`Data: ${todayBR()}`);
  lines.push(`Nome: ${data.user.name}`);
  lines.push(`Email: ${data.user.email}`);
  lines.push("");
  lines.push(`IGA: ${data.igaPct}%`);
  lines.push(`N√≠vel: ${data.level}`);
  lines.push(`Perfil: ${data.profile.title}`);
  lines.push(`Interpreta√ß√£o: ${data.profile.text}`);
  lines.push("");
  lines.push("M√≥dulos (%):");
  data.pctByDim.forEach((v,i)=> lines.push(`- ${DIMENSIONS[i].name}: ${Math.round(v)}%`));
  lines.push("");
  lines.push(`M√≠nimo saud√°vel por m√≥dulo: ${MIN_HEALTHY_PCT}%`);
  lines.push("");
  lines.push("Observa√ß√£o: o PDF e o HTML do resultado foram gerados para download no dispositivo do participante.");
  return lines.join("\n");
}

function openMailto(data){
  const subject = encodeURIComponent(`Resultado Autoestima ‚Äî ${data.user.name}`);
  const body = encodeURIComponent(buildMailtoBody(data));
  window.location.href = `mailto:${MAILTO_TO}?subject=${subject}&body=${body}`;
}

async function autoGenerateFilesAndEmail(){
  const hint = document.getElementById("autoActionsHint");
  hint.textContent = "A√ß√µes autom√°ticas: gerando PDF + HTML e abrindo e-mail‚Ä¶";

  // PDF (dispara download)
  await generatePDF(true);

  // HTML (dispara download)
  saveOfflineHTML(true);

  // mailto
  openMailto(window._igaData);

  hint.textContent = "Se o navegador bloquear downloads autom√°ticos, clique em ‚ÄúSalvar PDF‚Äù e ‚ÄúSalvar HTML‚Äù. O e-mail foi aberto no seu aplicativo padr√£o.";
}

/* =========================
   FINALIZAR
   ========================= */
async function finish(){
  if(responses[current] === null){ alert("Selecione uma op√ß√£o antes de continuar."); return; }
  if(responses.some(r => r === null)){ alert("Responda todas as perguntas."); return; }

  const s = score();
  const igaPct = pct(s.iga);
  const level = igaLevel(igaPct);
  const profile = igaProfile(igaPct);

  document.getElementById("test").classList.add("hidden");
  document.getElementById("result").classList.remove("hidden");

  document.getElementById("personalData").innerHTML =
    `<span class="font-bold">Nome:</span> ${sanitize(user.name)} | <span class="font-bold">Email:</span> ${sanitize(user.email)}`;

  document.getElementById("igaPct").textContent = `${igaPct}%`;
  document.getElementById("igaLevel").textContent = `N√≠vel: ${level}`;
  document.getElementById("profileTitle").textContent = profile.title;
  document.getElementById("profileText").textContent = profile.text;

  window._igaData = { user, igaPct, level, profile, pctByDim: s.pctByDim };

  renderAlerts(s.pctByDim);
  renderThemesChart(s.pctByDim);
  document.getElementById("moduleExplain").innerHTML = moduleDetailHTML(s.pctByDim);

  // a√ß√µes autom√°ticas solicitadas
  setTimeout(() => { autoGenerateFilesAndEmail(); }, 400);
}

/* =========================
   PDF / HTML
   ========================= */
async function generatePDF(silent=false){
  try{
    const data = window._igaData;
    if(!data){ if(!silent) alert("Gere o resultado antes de salvar PDF."); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ format:"a4" });

    doc.setFillColor(246, 253, 248);
    doc.rect(0,0,210,297,"F");

    doc.setFont("helvetica","bold");
    doc.setFontSize(18);
    doc.setTextColor(20,83,45);
    doc.text("Avalia√ß√£o N√≠vel de Autoestima", 105, 18, { align:"center" });

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.setTextColor(31,41,55);

    const header = `Nome: ${data.user.name} | Email: ${data.user.email} | Data: ${todayBR()}`;
    doc.text(doc.splitTextToSize(header, 180), 15, 30);

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text(`IGA: ${data.igaPct}% ‚Äî ${data.level}`, 15, 46);

    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text(`Perfil: ${data.profile.title}`, 15, 56);

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.text(doc.splitTextToSize(`Interpreta√ß√£o: ${data.profile.text}`, 180), 15, 64);

    // Captura gr√°fico por temas
    const chartCanvas = document.getElementById("themesChart");
    if(chartCanvas){
      const shot = await html2canvas(chartCanvas, { scale: 3, backgroundColor: "#ffffff" });
      const img = shot.toDataURL("image/png", 1.0);
      doc.addImage(img, "PNG", 15, 92, 180, 90);
    }

    // P√°gina 2: detalhes por m√≥dulos
    doc.addPage();
    doc.setFillColor(246, 253, 248);
    doc.rect(0,0,210,297,"F");

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(20,83,45);
    doc.text("Detalhamento por m√≥dulos", 105, 18, { align:"center" });

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.setTextColor(31,41,55);

    let y = 30;
    data.pctByDim.forEach((v,i)=>{
      const line = `${DIMENSIONS[i].name}: ${Math.round(v)}% (${Math.round(v) < MIN_HEALTHY_PCT ? "ABAIXO do m√≠nimo saud√°vel" : "OK"})`;
      doc.text(doc.splitTextToSize(line, 180), 15, y);
      y += 7;
      const expl = bandExplain(Math.round(v));
      doc.text(doc.splitTextToSize("Interpreta√ß√£o: " + expl, 180), 15, y);
      y += 12;
      if(y > 270){ doc.addPage(); y = 20; }
    });

    const pdfName = `Autoestima_${sanitize(data.user.name).replace(/\s+/g,"_")}.pdf`;
    doc.save(pdfName);
  }catch(e){
    console.error(e);
    if(!silent) alert("Erro ao gerar PDF.");
  }
}

function saveOfflineHTML(silent=false){
  const data = window._igaData;
  if(!data){ if(!silent) alert("Gere o resultado antes de salvar HTML."); return; }

  // Substituir canvas por imagem para offline
  const chartCanvas = document.getElementById("themesChart");
  let chartImgData = "";
  if(chartCanvas) chartImgData = chartCanvas.toDataURL("image/png", 1.0);

  const resultClone = document.querySelector("#result").cloneNode(true);
  const oldCanvas = resultClone.querySelector("#themesChart");
  if(oldCanvas && chartImgData){
    const img = document.createElement("img");
    img.src = chartImgData;
    img.alt = "Gr√°fico por m√≥dulos";
    img.style.width = "100%";
    img.style.maxWidth = "920px";
    img.style.height = "auto";
    img.style.display = "block";
    img.style.margin = "0 auto";
    oldCanvas.parentNode.replaceChild(img, oldCanvas);
  }

  // Remover bot√µes de a√ß√£o no arquivo offline (opcional: mant√©m, mas aqui eu removo pra ficar limpo)
  const btns = resultClone.querySelectorAll("button");
  btns.forEach(b => b.remove());

  const styleContent = `
    <style>
      body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#fff; margin:0; padding:20px; }
      .container{ max-width: 920px; margin:0 auto; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  `;

  const htmlContent = `
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Resultado Autoestima ‚Äî ${sanitize(data.user.name)}</title>
      ${styleContent}
    </head>
    <body>
      <div class="container">
        ${resultClone.outerHTML}
      </div>
    </body>
    </html>
  `;

  const blob = new Blob([htmlContent], { type:"text/html;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `Resultado_Autoestima_${sanitize(data.user.name).replace(/\s+/g,"_")}.html`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  URL.revokeObjectURL(url);
}

function restart(){
  questions = [];
  responses = [];
  current = 0;
  window._igaData = null;

  if(chartInstance){ chartInstance.destroy(); chartInstance = null; }

  document.getElementById("alerts").classList.add("hidden");
  document.getElementById("alerts").innerHTML = "";
  document.getElementById("moduleExplain").innerHTML = "";

  document.getElementById("result").classList.add("hidden");
  document.getElementById("test").classList.add("hidden");
  document.getElementById("intro").classList.remove("hidden");

  document.getElementById("name").value = "";
  document.getElementById("email").value = "";
}
</script>
</body>
</html>
